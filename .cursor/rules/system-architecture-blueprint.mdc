---
description: End-to-end architecture blueprint for building TPL-App features from scratch
alwaysApply: true
---

# System Architecture Blueprint

Use this rule as the default blueprint when designing or implementing new capabilities.

## Core system stance

- Backend API is the security and business-truth boundary.
- Frontend permission gating is UX support, not authorization enforcement.
- Prefer explicit, composable modules over monolithic handlers/components.

## Backend defaults

- Keep routers thin in `backend/app/routers/**`; place workflow/business rules in `backend/app/features/**/service.py`.
- Keep domain model in `backend/app/model/**`, API contracts in `backend/app/schema/**`, and wire imports through `backend/app/models.py`.
- Enforce permissions in routers (`require_permission(...)`), invariants in services, and structural integrity in DB relations/constraints.
- For external systems, use feature modules under `backend/app/features/interfaces/**` with client/mapper/service separation.

## Frontend defaults

- Build complex screens as thin container views plus composed `use*ViewModel` hooks.
- Decompose tabs/pages section-first into focused components under `frontend/src/views/<feature>/...`.
- Reuse shared styling and rendering utilities before introducing local one-off patterns.
- Keep behavior consistent with established edit/save/cancel and table action patterns unless explicitly changed.

## Data evolution protocol

- Treat model changes as cross-cutting: update model, schema, routers/services, frontend contracts/consumers, and docs in one change set.
- Review seed impact as mandatory; update seed loaders/datasets or explicitly document why no seed update is required.
- Prefer flexible template/value-set patterns over table-per-variant modeling when domains are extensible.

## Concurrency and integrity

- Default to ORM-level optimistic locking for mutable entities.
- Exclude append-only/event-style logs only when explicitly intended.
- Return clear conflict semantics (`409`) and keep frontend conflict UX actionable.

## Documentation and completion gate

- Update the most relevant manual(s) in `doc/` when behavior, architecture, or operations change.
- Validate changed flows with targeted checks (lint/build/compile/runtime path).
- Do not finish until dependent layers and manuals are aligned.
