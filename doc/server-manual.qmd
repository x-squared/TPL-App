# Server Manual

This manual explains how to configure and start the TPL backend server.

For detailed seeding behavior (core/sample/test data), see `doc/seeding-manual.qmd`.
For specification-to-test workflow, see `doc/specification-manual.qmd`.
For role/permission behavior and management, see `doc/access-control-manual.qmd`.

## 1) What "server" means in this project

The backend server is a FastAPI application started from:

- `backend/app/main.py`

By default, it uses a SQLite database at:

- `database/tpl_app.db`

## 2) Prerequisites

- Python 3.10+ (recommended)
- `pip`
- Terminal access to the repository root

## 3) First-time setup

From project root:

```{bash}
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## 4) Runtime configuration

The server reads configuration from environment variables centralized in:

- `backend/app/config.py`

### Core environment variables

- `TPL_ENV`: logical runtime environment (`DEV`, `TEST`, `PROD`)
- `TPL_DATABASE_URL`: database connection string (default: SQLite file in `database/`)
- `TPL_CORS_ORIGINS`: comma-separated allowed browser origins
- `TPL_SEED_PROFILE`: optional explicit seed profile override

### Support ticket mail configuration

Support ticket mail destination is configured via JSON file (not env vars):

- `backend/config/config`

Expected shape:

```json
{
  "support": {
    "email": "support@tpl-app.local"
  }
}
```

This address is exposed to the frontend via `GET /api/support-ticket/config` and used by the "Open Ticket" action in error banners.

Seed profile semantics and allowed values are documented in:

- `doc/seeding-manual.qmd`

### Recommended defaults

- Local development: `TPL_ENV=DEV`
- Production-like run: `TPL_ENV=PROD`
- Keep browser access default by including `http://localhost:5173` in `TPL_CORS_ORIGINS`

## 5) Start the backend server

From `backend/` with the virtual environment activated:

```{bash}
uvicorn app.main:app --reload
```

Server endpoints:

- API base: `http://localhost:8000`
- Health check: `http://localhost:8000/api/health`
- Swagger UI: `http://localhost:8000/docs`

## 6) Typical startup examples

### A) Development (core + sample seed data)

```{bash}
export TPL_ENV=DEV
uvicorn app.main:app --reload
```

### B) Production-safe seeding (core only)

```{bash}
export TPL_ENV=PROD
uvicorn app.main:app --reload
```

### C) Explicit profile override

```{bash}
export TPL_ENV=DEV
export TPL_SEED_PROFILE=CORE_TEST
uvicorn app.main:app --reload
```

### D) Custom DB and CORS configuration

```{bash}
export TPL_DATABASE_URL=sqlite:///../database/tpl_app.db
export TPL_CORS_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
uvicorn app.main:app --reload
```

## 7) Restarting the server

If running in terminal foreground:

- Stop with `Ctrl+C`
- Start again with the same `uvicorn ...` command

If running with `--reload`, code changes trigger automatic restart.

## 8) Troubleshooting

- **Port already in use**: stop the process using port `8000`, then restart.
- **Unexpected seed data**: verify `TPL_ENV` and `TPL_SEED_PROFILE`.
- **No seed changes visible**: run `python -m app.seed run ...` (or `python -m app.db_admin --mode refresh ...`) after changing seed files.
- **Need to run seeds manually**: use `python -m app.seed run ...` from `backend/`.
- **Import/runtime errors after dependency changes**: re-run `pip install -r requirements.txt`.

## 9) Operational notes

- Startup creates database tables via SQLAlchemy metadata.
- Startup also performs lightweight schema compatibility adjustments (for example, adding missing columns needed by newer code).
- Startup now also applies medical-value universe migrations:
  - creates datatype metadata table `MEDICAL_VALUE_DATATYPE`
  - adds context columns on `MEDICAL_VALUE` (`EPISODE_ID`, `ORGAN_ID`, `IS_DONOR_CONTEXT`, `CONTEXT_KEY`)
  - backfills patient `BLOOD_TYPE_ID` into static medical values and clears the patient column
- Startup does not run seeding. Use DB/seed scripts explicitly when data refresh is required.

For all seed design and profile details, always refer to:

- `doc/seeding-manual.qmd`
